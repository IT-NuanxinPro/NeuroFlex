name: Android Release

on:
  # Tag è§¦å‘ï¼ˆæŽ¨èï¼‰
  push:
    tags:
      - 'android-v*'

  # æ‰‹åŠ¨è§¦å‘ï¼ˆå¯é€‰æŒ‡å®šç‰ˆæœ¬ï¼‰
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚ 1.0.0)ï¼Œç•™ç©ºåˆ™ä»Ž package.json è¯»å–'
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸åˆ›å»º Release å’ŒæŽ¨é€ä»£ç 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Build web assets (without CDN)
        run: DISABLE_CDN=true pnpm build

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Setup signing
        run: |
          # ä½¿ç”¨debug keystoreè¿›è¡Œç­¾åï¼ˆç”Ÿäº§çŽ¯å¢ƒåº”ä½¿ç”¨æ­£å¼keystoreï¼‰
          echo "MYAPP_RELEASE_STORE_FILE=debug.keystore" >> android/gradle.properties
          echo "MYAPP_RELEASE_STORE_PASSWORD=android" >> android/gradle.properties
          echo "MYAPP_RELEASE_KEY_ALIAS=androiddebugkey" >> android/gradle.properties
          echo "MYAPP_RELEASE_KEY_PASSWORD=android" >> android/gradle.properties

      - name: Build Release APK
        working-directory: android
        run: ./gradlew assembleRelease

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.version }}" ]; then
            # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥çš„ç‰ˆæœ¬
            VERSION="${{ inputs.version }}"
          elif [[ "$GITHUB_REF" == refs/tags/android-v* ]]; then
            # Tag è§¦å‘æ—¶ä»Ž tag æå–ç‰ˆæœ¬
            VERSION="${GITHUB_REF#refs/tags/android-v}"
          else
            # ä»Ž package.json è¯»å–ç‰ˆæœ¬
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Build version: $VERSION"

      - name: Rename APK
        run: |
          mv android/app/build/outputs/apk/release/*.apk NeuroFlex-v${{ steps.get_version.outputs.VERSION }}.apk

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: android-v${{ steps.get_version.outputs.VERSION }}
          files: NeuroFlex-v${{ steps.get_version.outputs.VERSION }}.apk
          name: Android v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## NeuroFlex Android v${{ steps.get_version.outputs.VERSION }}

            ### ä¸‹è½½
            ç‚¹å‡»ä¸‹æ–¹ APK æ–‡ä»¶ä¸‹è½½å®‰è£…

            ### æ›´æ–°å†…å®¹
            - è¯·æŸ¥çœ‹ commit è®°å½•
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update app-version.json
        run: |
          # èŽ·å–ä¸‹è½½åŸŸåï¼Œä¼˜å…ˆä½¿ç”¨çŽ¯å¢ƒå˜é‡ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤å€¼
          DOWNLOAD_BASE_URL="${{ vars.DOWNLOAD_BASE_URL || 'https://download-neuroflex.061129.xyz' }}"
          
          mkdir -p public
          cat > public/app-version.json << EOF
          {
            "version": "${{ steps.get_version.outputs.VERSION }}",
            "versionCode": $(node -p "const v='${{ steps.get_version.outputs.VERSION }}'.split('.'); v[0]*10000+v[1]*100+Number(v[2])"),
            "downloadUrl": "${DOWNLOAD_BASE_URL}/android-v${{ steps.get_version.outputs.VERSION }}/NeuroFlex-v${{ steps.get_version.outputs.VERSION }}.apk",
            "githubUrl": "https://github.com/${{ github.repository }}/releases/download/android-v${{ steps.get_version.outputs.VERSION }}/NeuroFlex-v${{ steps.get_version.outputs.VERSION }}.apk",
            "changelog": "ç‰ˆæœ¬ ${{ steps.get_version.outputs.VERSION }} å‘å¸ƒ",
            "releaseDate": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Commit app-version.json
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add public/app-version.json
          git diff --cached --quiet || git commit -m "chore: update app-version.json to v${{ steps.get_version.outputs.VERSION }}"
          git push origin HEAD:main