name: Android Release

on:
  # Tag è§¦å‘ï¼ˆæŽ¨èï¼‰
  push:
    tags:
      - 'android-v*'

  # æ‰‹åŠ¨è§¦å‘ï¼ˆå¯é€‰æŒ‡å®šç‰ˆæœ¬ï¼‰
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚ 1.0.0)ï¼Œç•™ç©ºåˆ™ä»Ž package.json è¯»å–'
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸åˆ›å»º Release å’ŒæŽ¨é€ä»£ç 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Build web assets (without CDN)
        run: DISABLE_CDN=true pnpm build

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Complete cache cleanup (nuclear option)
        run: |
          # åˆ é™¤æ‰€æœ‰å¯èƒ½çš„ç¼“å­˜ç›®å½•
          sudo rm -rf ~/.gradle/
          sudo rm -rf ~/.android/
          sudo rm -rf ~/.m2/
          sudo rm -rf /tmp/gradle*
          sudo rm -rf /home/runner/.gradle/
          sudo rm -rf /home/runner/.android/
          
          # æ¸…ç†é¡¹ç›®ä¸­çš„æ‰€æœ‰æž„å»ºäº§ç‰©
          rm -rf android/.gradle/
          rm -rf android/build/
          rm -rf android/app/build/
          rm -rf android/capacitor-android/build/
          rm -rf android/capacitor-cordova-android-plugins/build/
          
          # æ¸…ç† Capacitor ç¼“å­˜
          rm -rf node_modules/.capacitor/
          rm -rf .capacitor/
          
          # æ¸…ç† npm/pnpm ç¼“å­˜
          pnpm store prune
          
          # ç¡®ä¿æƒé™æ­£ç¡®
          chmod +x android/gradlew

      - name: Sync Capacitor (force clean sync)
        run: |
          # å®Œå…¨é‡æ–°åŒæ­¥ Capacitor
          npx cap clean android
          npx cap sync android --force

      - name: Setup signing and Gradle properties
        run: |
          cd android
          
          # ä½¿ç”¨debug keystoreè¿›è¡Œç­¾åï¼ˆç”Ÿäº§çŽ¯å¢ƒåº”ä½¿ç”¨æ­£å¼keystoreï¼‰
          echo "MYAPP_RELEASE_STORE_FILE=debug.keystore" >> gradle.properties
          echo "MYAPP_RELEASE_STORE_PASSWORD=android" >> gradle.properties
          echo "MYAPP_RELEASE_KEY_ALIAS=androiddebugkey" >> gradle.properties
          echo "MYAPP_RELEASE_KEY_PASSWORD=android" >> gradle.properties
          
          # åŸºæœ¬çš„ Gradle é…ç½®ï¼ˆé¿å…å¤æ‚é…ç½®å¯¼è‡´é—®é¢˜ï¼‰
          echo "org.gradle.jvmargs=-Xmx3g -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError" >> gradle.properties
          echo "org.gradle.daemon=false" >> gradle.properties
          echo "org.gradle.parallel=false" >> gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties
          echo "android.useAndroidX=true" >> gradle.properties
          
          # åˆ›å»º Gradle åˆå§‹åŒ–è„šæœ¬æ¥å¤„ç†ä¾èµ–å†²çª
          mkdir -p ~/.gradle/init.d/
          cat > ~/.gradle/init.d/dependency-resolution.gradle << 'EOF'
          allprojects {
              configurations.all {
                  resolutionStrategy {
                      // æŽ’é™¤æœ‰é—®é¢˜çš„ BouncyCastle ç‰ˆæœ¬
                      eachDependency { DependencyResolveDetails details ->
                          if (details.requested.group == 'org.bouncycastle') {
                              if (details.requested.name.startsWith('bcprov') || 
                                  details.requested.name.startsWith('bcpkix') || 
                                  details.requested.name.startsWith('bcutil')) {
                                  // å¼ºåˆ¶ä½¿ç”¨å…¼å®¹ç‰ˆæœ¬
                                  details.useVersion '1.77'
                                  details.because 'Avoid Java 21 bytecode compatibility issues'
                              }
                          }
                      }
                  }
              }
          }
          EOF

      - name: Verify dependencies and build
        working-directory: android
        run: |
          # æ£€æŸ¥ä¾èµ–è§£æž
          echo "=== æ£€æŸ¥ BouncyCastle ä¾èµ–ç‰ˆæœ¬ ==="
          ./gradlew :app:dependencies --configuration releaseRuntimeClasspath | grep bouncycastle || echo "æœªæ‰¾åˆ° BouncyCastle ä¾èµ–"
          
          # æ¸…ç†å¹¶æž„å»º
          echo "=== å¼€å§‹æž„å»º ==="
          ./gradlew clean --no-daemon --no-parallel --stacktrace
          ./gradlew assembleRelease --no-daemon --no-parallel --stacktrace --info

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.version }}" ]; then
            # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥çš„ç‰ˆæœ¬
            VERSION="${{ inputs.version }}"
          elif [[ "$GITHUB_REF" == refs/tags/android-v* ]]; then
            # Tag è§¦å‘æ—¶ä»Ž tag æå–ç‰ˆæœ¬
            VERSION="${GITHUB_REF#refs/tags/android-v}"
          else
            # ä»Ž package.json è¯»å–ç‰ˆæœ¬
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Build version: $VERSION"

      - name: Rename APK
        run: |
          mv android/app/build/outputs/apk/release/*.apk NeuroFlex-v${{ steps.get_version.outputs.VERSION }}.apk

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: android-v${{ steps.get_version.outputs.VERSION }}
          files: NeuroFlex-v${{ steps.get_version.outputs.VERSION }}.apk
          name: Android v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## NeuroFlex Android v${{ steps.get_version.outputs.VERSION }}

            ### ä¸‹è½½
            ç‚¹å‡»ä¸‹æ–¹ APK æ–‡ä»¶ä¸‹è½½å®‰è£…

            ### æ›´æ–°å†…å®¹
            - è¯·æŸ¥çœ‹ commit è®°å½•
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update app-version.json
        run: |
          # èŽ·å–ä¸‹è½½åŸŸåï¼Œä¼˜å…ˆä½¿ç”¨çŽ¯å¢ƒå˜é‡ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤å€¼
          DOWNLOAD_BASE_URL="${{ vars.DOWNLOAD_BASE_URL || 'https://download-neuroflex.061129.xyz' }}"
          
          mkdir -p public
          cat > public/app-version.json << EOF
          {
            "version": "${{ steps.get_version.outputs.VERSION }}",
            "versionCode": $(node -p "const v='${{ steps.get_version.outputs.VERSION }}'.split('.'); v[0]*10000+v[1]*100+Number(v[2])"),
            "downloadUrl": "${DOWNLOAD_BASE_URL}/android-v${{ steps.get_version.outputs.VERSION }}/NeuroFlex-v${{ steps.get_version.outputs.VERSION }}.apk",
            "githubUrl": "https://github.com/${{ github.repository }}/releases/download/android-v${{ steps.get_version.outputs.VERSION }}/NeuroFlex-v${{ steps.get_version.outputs.VERSION }}.apk",
            "changelog": "ç‰ˆæœ¬ ${{ steps.get_version.outputs.VERSION }} å‘å¸ƒ",
            "releaseDate": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Commit app-version.json
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add public/app-version.json
          git diff --cached --quiet || git commit -m "chore: update app-version.json to v${{ steps.get_version.outputs.VERSION }}"
          git push origin HEAD:main